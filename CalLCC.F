! ZUO,NOV 15,2016
! CALLCC.F
! CONVERT(LATITUDE,LONGITUDE)TO LAMBERT CONFORMAL PROJECTION (X,Y) AND VISE VERSER.
      PROGRAM CALLCC
      IMPLICIT NONE
      DOUBLE PRECISION A,E2,E,PI
      DATA A,E2,E,PI/6378137,0.006694381,0.081819199
     & ,3.141592653585793238462/
      COMMON/CONSTANTS/A,E2,E,PI
C A: RADIUS OF EARTH, E: ELLIPSOIDAL FLATTENING ,E2=E**2
      DOUBLE PRECISION LAT0,LON0,LAT,LON,X,Y,LAT1,LAT2
        INTEGER::NX=180,NY=222,IX,IY
        REAL:: DGRIDKM=1000.,XORIGKM=-89625,YORIGKM=-249201.5
      LAT1=60.
      LAT2=30. ! SMALLER THAN LAT1
      LAT0=37.3
      LON0=106.
      ! TEST TOXY:
      !LAT=37.3
      !LON=105.5
      !PRINT*,LAT1,LAT2
      !CALL TOXY(LAT,LON,LAT0,LON0,LAT1,LAT2,X,Y)
      !PRINT*,"---------TOXY:",X,Y
      !X=43253.52153
      !Y=135.0683948
      do iy=1,ny
          y=yORIGKM+iy*DGRIDKM
          do ix=1,nx
              x=XORIGKM+ix*DGRIDKM
              CALL TOLL(X,Y,LAT0,LON0,LAT1,LAT2,LAT,LON)
      PRINT*,"---------TOLL:IY=",IY,",IX=",IX,",Y=",Y,",X=",X,",LAT=",LAT,",LON=",LON
          enddo
      enddo
      END PROGRAM
      SUBROUTINE TOXY(LAT,LON,LAT0,LON0,LAT1,LAT2,X,Y)
      IMPLICIT NONE
      DOUBLE PRECISION A,E2,E,PI
      COMMON/CONSTANTS/A,E2,E,PI
      ! INPUT: LAT,LON
      ! OUTPUT: X,Y
      ! PARAMATERS:LAT0,LON0,LAT1,LAT2
      DOUBLE PRECISION LAT0,LON0,LAT1,LAT2
      DOUBLE PRECISION LAT,LON,X,Y
      DOUBLE PRECISION M,T,M1,T1,M2,T2,N,F,R0,R,THETA,T0
      DOUBLE PRECISION RLAT1,RLAT2,RLAT0,RLON0,RLAT,RLON
      RLAT1=LAT1*PI/180
      RLAT2=LAT2*PI/180
      RLAT0=LAT0*PI/180
      RLON0=LON0*PI/180
      RLAT=LAT*PI/180
      RLON=LON*PI/180
      M=DCOS(RLAT)/DSQRT(1-E2*DSIN(RLAT)**2)
      T=DTAN(PI/4-RLAT/2)/((1-E*DSIN(RLAT))
     & /(1+E*DSIN(RLAT)))**(E/2)
      M1=DCOS(RLAT1)/DSQRT(1-E2*DSIN(RLAT1)**2)
      T1=DTAN(PI/4-RLAT1/2)/((1-E*DSIN(RLAT1))
     & /(1+E*DSIN(RLAT1)))**(E/2)
      M2=DCOS(RLAT2)/DSQRT(1-E2*DSIN(RLAT2)**2)
      T2=DTAN(PI/4-RLAT2/2)/((1-E*DSIN(RLAT2))
     & /(1+E*DSIN(LAT2)))
      T0=DTAN(PI/4-RLAT0/2)/((1-E*DSIN(RLAT0))
     & /(1+E*DSIN(RLAT0)))**(E/2)
      N=DLOG(M1/M2)/DLOG(T1/T2)
      F=M1/(N*T1**N)
      R0=A*F*T0**N
      R=A*F*T**N
      THETA=N*(RLON-RLON0)
      !PRINT*,"M,T",M,T
      !PRINT*,"M2,T2",M2,T2
      !PRINT*,"M1,T1",M1,T1
      !PRINT*,N
      !PRINT*,T
      !PRINT*,F
      !PRINT*,R0,"RLON0,RLON:",RLON0,RLON
      !PRINT*,R
      !PRINT*,THETA
      X=R*DSIN(THETA)
      Y=R0-R*DCOS(THETA)
      END SUBROUTINE
      SUBROUTINE TOLL(X,Y,LAT0,LON0,LAT1,LAT2,LAT,LON)
      IMPLICIT NONE
      ! EXCEL METHOD
      DOUBLE PRECISION A,E2,E,PI
      COMMON/CONSTANTS/A,E2,E,PI
      DOUBLE PRECISION LAT0,LON0,LAT1,LAT2
      DOUBLE PRECISION LAT,LON,X,Y
      DOUBLE PRECISION M0,T0,M1,T,T1,M2,T2,N,F,R0,R,THETA,LAMDA(5)
      DOUBLE PRECISION RLAT1,RLAT2,RLAT0,RLON0,RLAT,RLON
      INTEGER I
      ! INPUT: X,Y
      ! OUTPUT: LAT,LON
      ! PARAMATERS:LAT0,LON0,LAT1,LAT2
      !DOUBLE PRECISION X,YLAT,LON,
      RLAT1=LAT1*PI/180
      RLAT2=LAT2*PI/180
      RLAT0=LAT0*PI/180
      RLON0=LON0*PI/180
      !PRINT*,LAT0,RLAT0,DCOS(RLAT0),DCOS(RLAT0)/DSQRT(1-E2*DSIN(RLAT0)**2)
      M0=DCOS(RLAT0)/DSQRT(1-E2*DSIN(RLAT0)**2)
      T0=DTAN(PI/4-RLAT0/2)/(((1-E*DSIN(RLAT0))/(1+E*DSIN(RLAT0)))**(E/2))
C T0=DTAN(PI/4-RLAT0/2)/(((1-E*DSIN(RLAT0))/(1+E*DSIN(RLAT0)))**(E/2))
      M2=DCOS(RLAT2)/DSQRT(1-E2*DSIN(RLAT2)**2)
      T2=DTAN(PI/4-RLAT2/2)/((1-E*DSIN((RLAT2))
     & /(1+E*DSIN(RLAT2)))**(E/2))
      M1=DCOS(RLAT1)/DSQRT(1-E2*DSIN(RLAT1)**2)
      T1=DTAN(PI/4-RLAT1/2)/((1-E*DSIN((RLAT1))
     & /(1+E*DSIN(RLAT1)))**(E/2))
      !PRINT*,"M0,T0",M0,T0
      !PRINT*,"M1,T1",M1,T1
      !PRINT*,"M2,T2",M2,T2
      N=DLOG(M1/M2)/DLOG(T1/T2)
      F=M1/(N*T1**N)
      R0=A*F*T0**N
      !PRINT*,N,F,R0
      THETA=DATAN(X/(R0-Y))
      RLON=RLON0+THETA/N
      !??????????RLON=THETA/N-RLON0
      LON=RLON*180/PI
      R=DSQRT(X**2+(R0-Y)**2)
      T=(R/A/F)**(1/N)
      LAMDA(1)=PI/2-2*DATAN(T)
      LAMDA(2)=(E2/2+5/24*E2**2+E2**3/12+13/360*E2**4)*DSIN(2*LAMDA(1))
      LAMDA(3)=(7/48*E2**2+29/240*E2**3+811/11520*E2**4)*DSIN(4*LAMDA(1))
      LAMDA(4)=(7/120*E2**3+81/1120*E2**4)*DSIN(6*LAMDA(1))
      LAMDA(5)=4279/161280*E2**4*DSIN(8*LAMDA(1))
      !PRINT*,R,T,LAMDA(1)
      RLAT=0
      DO I=1,5
        RLAT=RLAT+LAMDA(I)
      ENDDO
      !PRINT*,'RLAT:',RLAT
      LAT=RLAT/PI*180
      !PRINT*,THETA,RLON,LON,RLAT,LAT
      END SUBROUTINE
